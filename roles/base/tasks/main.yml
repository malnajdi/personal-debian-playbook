---
# tasks file for base
- name: Install essential packages
  apt:
    name: "{{ essential_packages }}"

- name: Install Snaps Packages
  snap:
    name: "{{ item.name }}"
    classic: "{{ item.classic }}"
  loop: "{{ snap_packages }}"

- name: Create default directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ user }}"
    group: "{{ group }}"
  loop: "{{ directories }}"

# Compton
- name: Configure Compton
  template:
    src: compton.conf.j2
    dest: "{{ user_config_path }}/compton/compton.conf"
    owner: "{{ user }}"
    group: "{{ group }}"
  notify: restart compton

# Xmonad
- name: Configure xmonad
  template:
    src: xmonad.hs.j2
    dest: "{{ xmonad_config_path }}/xmonad.hs"
    owner: "{{ user }}"
    group: "{{ group }}"
  notify: restart xmonad

# Xmobar
- name: Configure xmobar
  template:
    src: xmobarrc.j2
    dest: "{{ user_config_path }}/xmobar/xmobarrc"
    owner: "{{ user }}"
    group: "{{ group }}"
  notify: restart xmonad

# Fonts
- name: Install Fonts
  copy:
    src: "{{ item }}"
    dest: "/usr/local/share/fonts/{{ item | basename }}"
    owner: root
    group: root
  loop: "{{ q('fileglob', 'files/fonts/*.ttf') }}"
  notify: update font cache

# Suckless Terminal
# TODO package should be downloaded and extracted and built
# File should be exists in this role.
- name: Check if suckless terminal (st) is installed 
  stat:
    path: /usr/local/bin/st
  register: st_installed

- name: Extract suckless terminal (st)
  unarchive:
    src: st-0.8.2.tar.gz
    dest: "{{ user_config_path }}"
    owner: "{{ user }}"
    group: "{{ group }}"
  when: not st_installed.stat.exists

- name: Configure suckless terminal (st)
  template:
    src: st_config.h.j2
    dest: "{{ user_config_path }}/st-0.8.2/config.h"
    owner: "{{ user }}"
    group: "{{ group }}"
  register: st_configured

- name: Build Suckless terminal (st)
  command: make clean install
  args: 
    chdir: "{{ user_config_path }}/st-0.8.2/"
  when: st_configured.changed

# Nitrogen & wallpapers
- name: Copy wallpapers
  synchronize:
    src: wallpapers/
    dest: "{{ user_wallpaper_path }}"

- name: Configure nitrogen & wallpaper
  template:
    src: "{{ item }}.j2"
    dest: "{{ user_config_path }}/nitrogen/{{ item }}"
    owner: "{{ user }}"
    group: "{{ group }}"
  loop: 
    - nitrogen.cfg
    - bg-saved.cfg
  register: nitrogen_status
  notify: restore nitrogen
  
# Lock Screen (i3lock)
- name: Scale lockscreen wallpaper
  command: "convert -scale 1920x1080 {{ user_wallpaper_path }}/{{ default_user_wallpaper_name }}.png {{ user_wallpaper_path }}/lockscreen.png"
  notify: restart xmonad
  when: nitrogen_status.changed

# Language
- name: Create change language script
  template:
    src: change-lang.sh.j2
    dest: "{{ user_config_path }}/change-lang.sh"
    owner: "{{ user }}"
    group: "{{ group }}"
    mode: a+x
  notify:
    - restart xmonad

# Bash Aliases
- name: Enable bash aliases
  template: 
    src: .bash_aliases.j2
    dest: "{{ user_home_path }}/.bash_aliases"
    owner: "{{ user }}"
    group: "{{ group }}"
    mode: 0644